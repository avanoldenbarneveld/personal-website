---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<'blog'>;
};

const { post } = Astro.props as Props;
const { Content } = await post.render();

// Get all posts for prev/next links
const posts = await getCollection('blog');
posts.sort((a, b) => {
  return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});

const index = posts.findIndex((p) => p.slug === post.slug);
const prevPost = posts[index + 1];
const nextPost = posts[index - 1];
---

<Layout title={post.data.title}>
  <article class="markdown-content">
    <header class="post-header">
      <h1>{post.data.title}</h1>
      {post.data.description && (
        <p class="post-description">{post.data.description}</p>
      )}
      <p class="post-date">
        Published on{" "}
        {post.data.pubDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })}
      </p>
    </header>

    <Content />
  </article>

  {(prevPost || nextPost) && (
    <nav style="
      display: flex;
      justify-content: space-between;
      margin-top: 3rem;
      padding: 1.5rem;
      background: #1f2123;
      border-radius: 8px;
    ">
      {prevPost ? (
        <a href={`/blog/${prevPost.slug}`} style="text-decoration: none; color: #bbb;">
          « PREV<br />
          <strong>{prevPost.data.title}</strong>
        </a>
      ) : <span></span>}

      {nextPost && (
        <a href={`/blog/${nextPost.slug}`} style="text-decoration: none; color: #bbb; text-align: right;">
          NEXT »<br />
          <strong>{nextPost.data.title}</strong>
        </a>
      )}
    </nav>
  )}

  <section id="comments" style="margin-top: 3rem;">
    <script src="https://giscus.app/client.js"
      data-repo="avanoldenbarneveld/personal-website"
      data-repo-id="R_kgDOPf7ksQ"
      data-category="Blog Comments"
      data-category-id="DIC_kwDOPf7ksc4Cu6cX"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="dark"
      data-lang="en"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </section>
</Layout>
